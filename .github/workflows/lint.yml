name: Lint

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: depot-ubuntu-24.04-16
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
          # Ensure we are on an actual branch (not a detached HEAD)
          ref: ${{ github.head_ref || github.ref }}

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.5'

      - id: dependency_cache_restore
        name: Restore dependencies cache
        uses: actions/cache/restore@v5
        with:
          path: |
            ./node_modules
            ~/.bun/install/cache
          key: modules-v3-${{ runner.os }}-bun-1.3.5-${{ hashFiles('bun.lock') }}

      - name: Install dependencies
        if: steps.dependency_cache_restore.outputs.cache-hit != 'true'
        run: bun install --frozen-lockfile --ignore-scripts

      - name: Save dependencies cache
        if: steps.dependency_cache_restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          path: |
            ./node_modules
            ~/.bun/install/cache
          key: ${{ steps.dependency_cache_restore.outputs.cache-primary-key }}

      - name: Run linter
        id: lint
        continue-on-error: true
        run: bun run lint

      - name: Auto-fix with linter
        if: steps.lint.outcome == 'failure'
        run: bun run lint:fix

      - name: Show diff, commit and push fixes (non-master/main only)
        if: |
          steps.lint.outcome == 'failure' &&
          github.ref != 'refs/heads/master' &&
          github.ref != 'refs/heads/main' &&
          (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository))
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          echo "Preparing to push fixes to $BRANCH"

          # Ensure we're on a branch, not detached HEAD
          git checkout -B "$BRANCH"

          git config user.name "codecrafters-bot"
          git config user.email "hello@codecrafters.io"

          # Only commit if there are changes
          if ! git diff --quiet; then
            echo "Auto-fix diff (before commit):"
            git --no-pager diff
            git add -A
            git commit -m "chore(lint): auto-fix lint offenses"
            git remote set-url origin "https://x-access-token:${{ secrets.CODECRAFTERS_BOT_TOKEN_FOR_LINT_FIXES }}@github.com/${{ github.repository }}.git"
            git push origin HEAD:"$BRANCH"
          else
            echo "No changes to commit"
          fi

      - name: Fail if linting failed
        if: steps.lint.outcome == 'failure'
        run: |
          echo "Linting failed. Auto-fixes (if any) have been pushed back to the branch. Failing the job to keep visibility."
          exit 1

